jQuery.trumbowyg={langs:{en:{viewHTML:"View HTML",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",del:"Deleted",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",insertVideo:"Insert Video",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",removeformat:"Remove format",fullscreen:"fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",required:"Required",description:"Description",title:"Title",text:"Text",target:"Target"}},opts:{},btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em","del"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]}},function(a,b,c,d,e){"use strict";d.fn.trumbowyg=function(a,b){if(a===Object(a)||!a)return this.each(function(){d(this).data("trumbowyg")||d(this).data("trumbowyg",new f(this,a))});if(1===this.length)try{var c=d(this).data("trumbowyg");switch(a){case"openModal":return c.openModal(b.title,b.content);case"closeModal":return c.closeModal();case"openModalInsert":return c.openModalInsert(b.title,b.fields,b.callback);case"saveSelection":return c.saveSelection();case"getSelection":return c.selection;case"getSelectedText":return c.getSelectedText();case"restoreSelection":return c.restoreSelection();case"destroy":return c.destroy();case"empty":return c.empty();case"lang":return c.lang;case"html":return c.html(b)}}catch(e){}return!1};var f=function(a,b){var e=this;e.doc=a.ownerDocument||c,e.$ta=d(a),e.$c=d(a),b=d.extend(!0,{},b,d.trumbowyg.opts),e.lang="undefined"==typeof b.lang||"undefined"==typeof d.trumbowyg.langs[b.lang]?d.trumbowyg.langs.en:d.extend(!0,{},d.trumbowyg.langs.en,d.trumbowyg.langs[b.lang]);var f=e.lang.header;e.o=d.extend(!0,{},{lang:"en",dir:"ltr",closable:!1,fullscreenable:!0,fixedBtnPane:!1,fixedFullWidth:!1,autogrow:!1,prefix:"trumbowyg-",semantic:!0,resetCss:!1,removeformatPasted:!1,tagsToRemove:[],btns:["viewHTML","|","formatting","|","btnGrp-design","|","link","|","insertImage","|","btnGrp-justify","|","btnGrp-lists","|","horizontalRule","|","removeformat"],btnsAdd:[],btnsDef:{viewHTML:{func:"toggle"},p:{func:"formatBlock"},blockquote:{func:"formatBlock"},h1:{func:"formatBlock",title:f+" 1"},h2:{func:"formatBlock",title:f+" 2"},h3:{func:"formatBlock",title:f+" 3"},h4:{func:"formatBlock",title:f+" 4"},bold:{key:"B"},italic:{key:"I"},underline:{},strikethrough:{},strong:{func:"bold",key:"B"},em:{func:"italic",key:"I"},del:{func:"strikethrough"},createLink:{key:"K"},unlink:{},insertImage:{},justifyLeft:{},justifyCenter:{},justifyRight:{},justifyFull:{},unorderedList:{func:"insertUnorderedList"},orderedList:{func:"insertOrderedList"},horizontalRule:{func:"insertHorizontalRule"},removeformat:{},formatting:{dropdown:["p","blockquote","h1","h2","h3","h4"]},link:{dropdown:["createLink","unlink"]}},inlineElementsSelector:"a, abbr, acronym, b, caption, cite, code, col, dfn, dir, dt, dd, em, font, hr, i, kbd, li, q, span, strikeout, strong, sub, sup, u"},b),b.btns?e.o.btns=b.btns:e.o.semantic&&(e.o.btns[4]="btnGrp-semantic"),e.keys=[],e.init()};f.prototype={init:function(){var a=this;a.height=a.$ta.height(),a.buildEditor(),a.buildBtnPane(),a.fixedBtnPaneEvents(),a.buildOverlay()},buildEditor:function(){var a=this,e=a.o.prefix,f="";a.$box=d("<div/>",{"class":e+"box "+e+"editor-visible "+e+a.o.lang+" trumbowyg"}),a.isTextarea=a.$ta.is("textarea"),a.isTextarea?(f=a.$ta.val(),a.$ed=d("<div/>"),a.$box.insertAfter(a.$ta).append(a.$ed,a.$ta)):(a.$ed=a.$ta,f=a.$ed.html(),a.$ta=d("<textarea/>",{name:a.$ta.attr("id"),height:a.height}).val(f),a.$box.insertAfter(a.$ed).append(a.$ta,a.$ed),a.syncCode()),a.$ta.addClass(e+"textarea").attr("tabindex",-1),a.$ed.addClass(e+"editor").attr({contenteditable:!0,dir:a.lang._dir||a.o.dir}).html(f),a.o.tabindex&&a.$ed.attr("tabindex",a.o.tabindex),a.$c.is("[placeholder]")&&a.$ed.attr("placeholder",a.$c.attr("placeholder")),a.o.resetCss&&a.$ed.addClass(e+"reset-css"),a.o.autogrow||a.$ta.add(a.$ed).css({height:a.height}),a.semanticCode(),a._ctrl=!1,a.$ed.on("dblclick","img",function(){var b=d(this);return a.openModalInsert(a.lang.insertImage,{url:{label:"URL",value:b.attr("src"),required:!0},alt:{label:a.lang.description,value:b.attr("alt")}},function(a){return b.attr({src:a.url,alt:a.alt})}),!1}).on("keydown",function(b){if(a._composition=229===b.which,b.ctrlKey){a._ctrl=!0;var c=a.keys[String.fromCharCode(b.which).toUpperCase()];try{return a.execCmd(c.func,c.param),!1}catch(b){}}}).on("keyup",function(b){a._ctrl||17===b.which||a._composition||(a.semanticCode(!1,13===b.which),a.$c.trigger("tbwchange")),setTimeout(function(){a._ctrl=!1},200)}).on("focus blur",function(b){a.$c.trigger("tbw"+b.type)}).on("paste",function(d){if(a.o.removeformatPasted){d.preventDefault();try{var e=b.clipboardData.getData("Text");try{a.doc.selection.createRange().pasteHTML(e)}catch(f){a.doc.getSelection().getRangeAt(0).insertNode(c.createTextNode(e))}}catch(f){a.execCmd("insertText",(d.originalEvent||d).clipboardData.getData("text/plain"))}}setTimeout(function(){a.o.semantic?a.semanticCode(!1,!0):a.syncCode(),a.$c.trigger("tbwpaste",d)},0)}),a.$ta.on("keyup paste",function(){a.$c.trigger("tbwchange")}),d(a.doc).on("keydown",function(b){return 27===b.which?(a.closeModal(),!1):void 0})},buildBtnPane:function(){var a=this,c=a.o.prefix;if(a.o.btns!==!1){a.$btnPane=d("<ul/>",{"class":c+"button-pane"}),d.each(a.o.btns.concat(a.o.btnsAdd),function(b,f){try{var g=f.split("btnGrp-");g[1]!==e&&(f=d.trumbowyg.btnsGrps[g[1]])}catch(h){}d.isArray(f)||(f=[f]),d.each(f,function(b,e){try{var f=d("<li/>");"|"===e?f.addClass(c+"separator"):a.isSupportedBtn(e)&&f.append(a.buildBtn(e)),a.$btnPane.append(f)}catch(g){}})});var f=d("<li/>",{"class":c+"not-disable "+c+"buttons-right"});a.o.fullscreenable&&f.append(a.buildRightBtn("fullscreen").on("click",function(){var e=c+"fullscreen";a.$box.toggleClass(e),d("body").toggleClass(c+"body-fullscreen",a.$box.hasClass(e)),d(b).trigger("scroll")})),a.o.closable&&f.append(a.buildRightBtn("close").on("click",function(){a.$box.removeClass(c+"fullscreen"),a.destroy(),a.$c.trigger("tbwclose")})),f.not(":empty")&&a.$btnPane.append(f),a.$box.prepend(a.$btnPane)}},buildBtn:function(a){var b=this,c=b.o.prefix,e=b.o.btnsDef[a],f=e.dropdown,g=b.lang[a]||a,h=d("<button/>",{type:"button","class":c+a+"-button"+(e.ico?" "+c+e.ico+"-button":""),text:e.text||e.title||g,title:e.title||e.text||g+(e.key?" (Ctrl + "+e.key+")":""),tabindex:-1,mousedown:function(){return(!f||d("."+a+"-"+c+"dropdown",b.$box).is(":hidden"))&&d("body",b.doc).trigger("mousedown"),!b.$btnPane.hasClass(c+"disable")||d(this).hasClass(c+"active")||d(this).parent().hasClass(c+"not-disable")?(b.execCmd((f?"dropdown":!1)||e.func||a,e.param||a),!1):!1}});if(f){h.addClass(c+"open-dropdown");var i=c+"dropdown",j=d("<div/>",{"class":a+"-"+i+" "+i+" "+c+"fixed-top"});d.each(f,function(a,c){b.o.btnsDef[c]&&b.isSupportedBtn(c)&&j.append(b.buildSubBtn(c))}),b.$box.append(j.hide())}else e.key&&(b.keys[e.key]={func:e.func||a,param:e.param||a});return h},buildSubBtn:function(a){var b=this,c=b.o.btnsDef[a];return c.key&&(b.keys[c.key]={func:c.func||a,param:c.param||a}),d("<button/>",{type:"button","class":b.o.prefix+a+"-dropdown-button"+(c.ico?" "+b.o.prefix+c.ico+"-button":""),text:c.text||c.title||b.lang[a]||a,title:c.key?" (Ctrl + "+c.key+")":null,style:c.style||null,mousedown:function(){return d("body",b.doc).trigger("mousedown"),b.execCmd(c.func||a,c.param||a),!1}})},buildRightBtn:function(a){var b=this.lang[a];return d("<button/>",{type:"button","class":this.o.prefix+a+"-button",title:b,text:b,tabindex:-1})},isSupportedBtn:function(a){try{return this.o.btnsDef[a].isSupported()}catch(b){}return!0},buildOverlay:function(){var a=this;return a.$overlay=d("<div/>",{"class":a.o.prefix+"overlay"}).css({top:a.$btnPane.outerHeight(),height:a.$ed.outerHeight()+1+"px"}).appendTo(a.$box),a.$overlay},showOverlay:function(){var a=this;d(b).trigger("scroll"),a.$overlay.fadeIn(200),a.$box.addClass(a.o.prefix+"box-blur")},hideOverlay:function(){var a=this;a.$overlay.fadeOut(50),a.$box.removeClass(a.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){var a=this,c=a.o.fixedFullWidth,e=a.$box;a.o.fixedBtnPane&&(a.isFixed=!1,d(b).on("scroll resize",function(){if(e){a.syncCode();var f=d(b).scrollTop(),g=e.offset().top+1,h=a.$btnPane,i=h.outerHeight();f-g>0&&f-g-a.height<0?(a.isFixed||(a.isFixed=!0,h.css({position:"fixed",top:0,left:c?"0":"auto",zIndex:7}),d([a.$ta,a.$ed]).css({marginTop:h.height()})),h.css({width:c?"100%":e.width()-1+"px"}),d("."+a.o.prefix+"fixed-top",e).css({position:c?"fixed":"absolute",top:c?i:i+(f-g)+"px",zIndex:15})):a.isFixed&&(a.isFixed=!1,h.removeAttr("style"),d([a.$ta,a.$ed]).css({marginTop:0}),d("."+a.o.prefix+"fixed-top",e).css({position:"absolute",top:i}))}}))},destroy:function(){var a=this,b=a.o.prefix,c=a.height;a.$box.after(a.isTextarea?a.$ta.css({height:c}).val(a.html()).removeClass(b+"textarea").show():a.$ed.css({height:c}).removeClass(b+"editor").removeAttr("contenteditable").html(a.html()).show()),a.$box.remove(),a.$c.removeData("trumbowyg")},empty:function(){this.$ta.val(""),this.syncCode(!0)},toggle:function(){var a=this,b=a.o.prefix;a.semanticCode(!1,!0),setTimeout(function(){a.$box.toggleClass(b+"editor-hidden "+b+"editor-visible"),a.$btnPane.toggleClass(b+"disable"),d("."+b+"viewHTML-button",a.$btnPane).toggleClass(b+"active"),a.$box.hasClass(b+"editor-visible")?a.$ta.attr("tabindex",-1):a.$ta.removeAttr("tabindex")},0)},dropdown:function(a){var c=this,e=c.doc,f=c.o.prefix,g=d("."+a+"-"+f+"dropdown",c.$box),h=d("."+f+a+"-button",c.$btnPane);if(g.is(":hidden")){var i=h.offset().left;h.addClass(f+"active"),g.css({position:"absolute",top:c.$btnPane.outerHeight(),left:c.o.fixedFullWidth&&c.isFixed?i+"px":i-c.$btnPane.offset().left+"px"}).show(),d(b).trigger("scroll"),d("body",e).on("mousedown",function(){d("."+f+"dropdown",e).hide(),d("."+f+"active",e).removeClass(f+"active"),d("body",e).off("mousedown")})}else d("body",e).trigger("mousedown")},html:function(a){var b=this;return a?(b.$ta.val(a),b.syncCode(!0),b):b.$ta.val()},syncCode:function(a){var b=this;!a&&b.$ed.is(":visible")?(b.$ta.val(b.$ed.html()),b.$c.trigger("tbwchange")):b.$ed.html(b.$ta.val()),b.o.autogrow&&(b.height=b.$ed.height(),b.height!=b.$ta.css("height")&&(b.$ta.css({height:b.height}),b.$c.trigger("tbwresize")))},semanticCode:function(a,b){var c=this;if(c.syncCode(a),c.saveSelection(),c.o.tagsToRemove.length>0&&d(c.o.tagsToRemove.join(", "),c.$ed).remove(),c.o.semantic){if(c.semanticTag("b","strong"),c.semanticTag("i","em"),c.semanticTag("strike","del"),b){var e=c.o.inlineElementsSelector,f=":not("+c.o.inlineElementsSelector+")";c.$ed.contents().filter(function(){return 3===this.nodeType&&d.trim(this.nodeValue).length>0}).wrap("<span data-trumbowyg-textnode/>");var g=function(a){if(0!==a.length){var b=a.nextUntil(f).andSelf().wrapAll("<p/>").parent();b.next("br").remove();var c=b.nextAll(e).first();c.length&&g(c)}};g(c.$ed.children(e).first()),c.semanticTag("div","p",!0),c.$ed.find("p").filter(function(){return c.selection&&this===c.selection.startContainer?!1:0===d(this).text().trim().length&&0===d(this).children().not("br, span").length}).contents().unwrap(),d("[data-trumbowyg-textnode]",c.$ed).contents().unwrap(),c.$ed.find("p:empty").replaceWith("<br/>")}c.restoreSelection(),c.$ta.val(c.$ed.html())}},semanticTag:function(a,b,c){d(a,this.$ed).each(function(){var a=d(this);a.wrap("<"+b+"/>"),c&&d.each(a.prop("attributes"),function(){a.parent().attr(this.name,this.value)}),a.contents().unwrap()})},createLink:function(){var a=this;a.saveSelection(),a.openModalInsert(a.lang.createLink,{url:{label:"URL",required:!0},title:{label:a.lang.title},text:{label:a.lang.text,value:a.getSelectedText()},target:{label:a.lang.target}},function(b){var c=d(['<a href="',b.url,'">',b.text,"</a>"].join(""));return b.title.length>0&&c.attr("title",b.title),b.target.length>0&&c.attr("target",b.target),a.selection.deleteContents(),a.selection.insertNode(c.get(0)),a.restoreSelection(),!0})},insertImage:function(){var a=this;a.saveSelection(),a.openModalInsert(a.lang.insertImage,{url:{label:"URL",required:!0},alt:{label:a.lang.description,value:a.getSelectedText()}},function(b){return a.execCmd("insertImage",b.url),d('img[src="'+b.url+'"]:not([alt])',a.$box).attr("alt",b.alt),!0})},execCmd:function(b,c){var d=this;"dropdown"!=b&&d.$ed.focus();try{d[b](c)}catch(e){try{b(c,d)}catch(f){"insertHorizontalRule"==b?c=null:"formatBlock"!=b||-1===a.userAgent.indexOf("MSIE")&&-1===a.appVersion.indexOf("Trident/")||(c="<"+c+">"),d.doc.execCommand(b,!1,c)}}"dropdown"!=b&&d.syncCode()},openModal:function(a,c){var e=this,f=e.o.prefix;if(d("."+f+"modal-box",e.$box).length>0)return!1;e.saveSelection(),e.showOverlay(),e.$btnPane.addClass(f+"disable");var g=d("<div/>",{"class":f+"modal "+f+"fixed-top"}).css({top:e.$btnPane.height()+1+"px"}).appendTo(e.$box);e.$overlay.one("click",function(){return g.trigger(f+"cancel"),!1});var h=d("<form/>",{action:"",html:c}).on("submit",function(){return g.trigger(f+"confirm"),!1}).on("reset",function(){return g.trigger(f+"cancel"),!1}),i=d("<div/>",{"class":f+"modal-box",html:h}).css({top:"-"+e.$btnPane.outerHeight()+"px",opacity:0}).appendTo(g).animate({top:0,opacity:1},100);return d("<span/>",{text:a,"class":f+"modal-title"}).prependTo(i),g.height(i.outerHeight()+10),d("input:first",i).focus(),e.buildModalBtn("submit",i),e.buildModalBtn("reset",i),d(b).trigger("scroll"),g},buildModalBtn:function(a,b){var c=this,e=c.o.prefix;return d("<button/>",{"class":e+"modal-button "+e+"modal-"+a,type:a,text:c.lang[a]||a}).appendTo(d("form",b))},closeModal:function(){var a=this,b=a.o.prefix;a.$btnPane.removeClass(b+"disable"),a.$overlay.off();var c=d("."+b+"modal-box",a.$box);c.animate({top:"-"+c.height()},100,function(){c.parent().remove(),a.hideOverlay()}),a.restoreSelection()},openModalInsert:function(a,b,c){var e=this,f=e.o.prefix,g=e.lang,h="";return d.each(b,function(a,b){var c=b.label,d=b.name||a;h+='<label><input type="'+(b.type||"text")+'" name="'+d+'" value="'+(b.value||"")+'"><span class="'+f+'input-infos"><span>'+(c?g[c]?g[c]:c:g[a]?g[a]:a)+"</span></span></label>"}),e.openModal(a,h).on(f+"confirm",function(){var a=d("form",d(this)),g=!0,h={};d.each(b,function(b,c){var f=d('input[name="'+b+'"]',a);h[b]=d.trim(f.val()),c.required&&""===h[b]?(g=!1,e.addErrorOnModalField(f,e.lang.required)):c.pattern&&!c.pattern.test(h[b])&&(g=!1,e.addErrorOnModalField(f,c.patternError))}),g&&(e.restoreSelection(),c(h,b)&&(e.syncCode(),e.closeModal(),d(this).off(f+"confirm")))}).one(f+"cancel",function(){d(this).off(f+"confirm"),e.closeModal()})},addErrorOnModalField:function(a,b){var c=this.o.prefix,e=a.parent();a.on("change keyup",function(){e.removeClass(c+"input-error")}),e.addClass(c+"input-error").find("input+span").append(d("<span/>",{"class":c+"msg-error",text:b}))},saveSelection:function(){var a=this,b=a.doc.selection;if(a.selection=null,a.doc.getSelection){var c=a.doc.getSelection();c.getRangeAt&&c.rangeCount&&(a.selection=c.getRangeAt(0))}else b&&b.createRange&&(a.selection=b.createRange())},restoreSelection:function(){var a=this,b=a.selection;if(b)if(a.doc.getSelection){var c=a.doc.getSelection();try{c.removeAllRanges()}catch(d){}c.addRange(b)}else a.doc.selection&&b.select&&b.select()},getSelectedText:function(){var a=this.selection;return a.text!==e?a.text:a+""}}}(navigator,window,document,jQuery);